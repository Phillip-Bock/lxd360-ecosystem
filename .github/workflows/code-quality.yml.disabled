# Code Quality Enforcement Workflow
# Purpose: Enforce code quality standards and prevent forbidden patterns
# Runs on all pushes and PRs to main/develop branches
# Owner: @Phillip-Bock

name: Code Quality

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main, develop]

# Cancel in-progress runs for the same branch
concurrency:
  group: code-quality-${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

permissions:
  contents: read

jobs:
  # Check for forbidden patterns before any other checks
  forbidden-patterns:
    name: Forbidden Patterns Check
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Check for eslint-disable comments
        run: |
          echo "Checking for eslint-disable comments..."
          if grep -rn "eslint-disable" --include="*.ts" --include="*.tsx" app/ components/ lib/ hooks/ types/ 2>/dev/null; then
            echo "::error::eslint-disable comments found. Fix the actual issues instead of suppressing warnings."
            exit 1
          fi
          echo "No eslint-disable comments found"

      - name: Check for TypeScript escape hatches
        run: |
          echo "Checking for @ts-ignore, @ts-nocheck, @ts-expect-error..."
          if grep -rn "@ts-ignore\|@ts-nocheck\|@ts-expect-error" --include="*.ts" --include="*.tsx" app/ components/ lib/ hooks/ types/ 2>/dev/null; then
            echo "::error::TypeScript escape hatches found. Add proper types instead."
            exit 1
          fi
          echo "No TypeScript escape hatches found"

      - name: Check for any type usage
        run: |
          echo "Checking for 'any' type usage..."
          if grep -rn ": any[^a-zA-Z]\|as any[^a-zA-Z]\|<any>" --include="*.ts" --include="*.tsx" app/ components/ lib/ hooks/ types/ 2>/dev/null; then
            echo "::error::'any' type usage found. Define proper TypeScript interfaces."
            exit 1
          fi
          echo "No 'any' type usage found"

      - name: Check for raw img tags
        run: |
          echo "Checking for raw <img> tags..."
          if grep -rn "<img " --include="*.tsx" app/ components/ 2>/dev/null; then
            echo "::error::Raw <img> tags found. Use next/image instead."
            exit 1
          fi
          echo "No raw <img> tags found"

      - name: Check for console.log
        run: |
          echo "Checking for console.log statements..."
          if grep -rn "console\.\(log\|info\|debug\|trace\)" --include="*.ts" --include="*.tsx" app/ components/ lib/ hooks/ 2>/dev/null; then
            echo "::error::console.log statements found. Use console.error for errors only, or remove debug logs."
            exit 1
          fi
          echo "No console.log statements found"

      - name: Pattern check passed
        run: |
          echo ""
          echo "All forbidden pattern checks passed!"
          echo ""

  # Run linting with zero tolerance for warnings
  lint:
    name: ESLint
    runs-on: ubuntu-latest
    needs: [forbidden-patterns]

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install pnpm
        uses: pnpm/action-setup@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'pnpm'

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Run ESLint
        run: pnpm lint --max-warnings=0

  # Run TypeScript type checking
  type-check:
    name: TypeScript Check
    runs-on: ubuntu-latest
    needs: [forbidden-patterns]

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install pnpm
        uses: pnpm/action-setup@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'pnpm'

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Run TypeScript type check
        run: pnpm typecheck

  # Build the application
  build:
    name: Build
    runs-on: ubuntu-latest
    needs: [lint, type-check]

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install pnpm
        uses: pnpm/action-setup@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'pnpm'

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Build application
        run: pnpm build
        env:
          # Firebase/GCP environment configured in Cloud Run
          NEXT_PUBLIC_FIREBASE_PROJECT_ID: ${{ secrets.NEXT_PUBLIC_FIREBASE_PROJECT_ID || 'lxd-saas-dev' }}

  # Summary job
  summary:
    name: Quality Summary
    runs-on: ubuntu-latest
    needs: [forbidden-patterns, lint, type-check, build]
    if: always()

    steps:
      - name: Create summary
        run: |
          if [ "${{ needs.build.result }}" = "success" ]; then
            echo "## Code Quality Checks Passed" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "All code quality checks completed successfully." >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "| Check | Status |" >> $GITHUB_STEP_SUMMARY
            echo "|-------|--------|" >> $GITHUB_STEP_SUMMARY
            echo "| Forbidden Patterns | Passed |" >> $GITHUB_STEP_SUMMARY
            echo "| ESLint | Passed |" >> $GITHUB_STEP_SUMMARY
            echo "| TypeScript | Passed |" >> $GITHUB_STEP_SUMMARY
            echo "| Build | Passed |" >> $GITHUB_STEP_SUMMARY
          else
            echo "## Code Quality Checks Failed" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "One or more code quality checks failed. Review the logs above." >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "| Check | Status |" >> $GITHUB_STEP_SUMMARY
            echo "|-------|--------|" >> $GITHUB_STEP_SUMMARY
            echo "| Forbidden Patterns | ${{ needs.forbidden-patterns.result }} |" >> $GITHUB_STEP_SUMMARY
            echo "| ESLint | ${{ needs.lint.result }} |" >> $GITHUB_STEP_SUMMARY
            echo "| TypeScript | ${{ needs.type-check.result }} |" >> $GITHUB_STEP_SUMMARY
            echo "| Build | ${{ needs.build.result }} |" >> $GITHUB_STEP_SUMMARY
          fi
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Branch:** ${{ github.ref_name }}" >> $GITHUB_STEP_SUMMARY
          echo "**Commit:** \`${{ github.sha }}\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "---" >> $GITHUB_STEP_SUMMARY
          echo "*Code quality enforced by CLAUDE.md rules*" >> $GITHUB_STEP_SUMMARY
